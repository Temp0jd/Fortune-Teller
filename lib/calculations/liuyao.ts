// 六十四卦数据
export const LIU_SI_SI_GUA: Record<string, { name: string; guaCi: string; yao: string[] }> = {
  '111111': { name: '乾为天', guaCi: '元亨利贞。', yao: ['潜龙勿用。', '见龙在田，利见大人。', '君子终日乾乾，夕惕若，厉无咎。', '或跃在渊，无咎。', '飞龙在天，利见大人。', '亢龙有悔。'] },
  '000000': { name: '坤为地', guaCi: '元亨，利牝马之贞。', yao: ['履霜，坚冰至。', '直方大，不习无不利。', '含章可贞。或从王事，无成有终。', '括囊，无咎无誉。', '黄裳，元吉。', '龙战于野，其血玄黄。'] },
  '100010': { name: '水雷屯', guaCi: '元亨利贞，勿用有攸往，利建侯。', yao: ['磐桓，利居贞，利建侯。', '屯如邅如，乘马班如。匪寇婚媾。', '即鹿无虞，惟入于林中。', '乘马班如，求婚媾，往吉，无不利。', '屯其膏，小贞吉，大贞凶。', '乘马班如，泣血涟如。'] },
  '010001': { name: '山水蒙', guaCi: '亨。匪我求童蒙，童蒙求我。', yao: ['发蒙，利用刑人，用说桎梏。', '包蒙，吉。纳妇，吉。子克家。', '勿用取女，见金夫，不有躬。', '困蒙，吝。', '童蒙，吉。', '击蒙，不利为寇，利御寇。'] },
  '111010': { name: '水天需', guaCi: '有孚，光亨，贞吉，利涉大川。', yao: ['需于郊，利用恒，无咎。', '需于沙，小有言，终吉。', '需于泥，致寇至。', '需于血，出自穴。', '需于酒食，贞吉。', '入于穴，有不速之客三人来，敬之终吉。'] },
  '010111': { name: '天水讼', guaCi: '有孚，窒惕，中吉，终凶。', yao: ['不永所事，小有言，终吉。', '不克讼，归而逋。', '食旧德，贞厉，终吉。', '不克讼，复即命，渝安贞，吉。', '讼，元吉。', '或锡之鞶带，终朝三褫之。'] },
  '010000': { name: '地水师', guaCi: '贞，丈人吉，无咎。', yao: ['师出以律，否臧凶。', '在师中，吉，无咎。王三锡命。', '师或舆尸，凶。', '师左次，无咎。', '田有禽，利执言，无咎。', '大君有命，开国承家，小人勿用。'] },
  '000010': { name: '水地比', guaCi: '吉。原筮，元永贞，无咎。', yao: ['有孚比之，无咎。', '比之自内，贞吉。', '比之匪人。', '外比之，贞吉。', '显比，王用三驱，失前禽。', '比之无首，凶。'] },
  '111011': { name: '风天小畜', guaCi: '亨。密云不雨，自我西郊。', yao: ['复自道，何其咎，吉。', '牵复，吉。', '舆说辐，夫妻反目。', '有孚，血去惕出，无咎。', '有孚挛如，富以其邻。', '既雨既处，尚德载，妇贞厉。'] },
  '110111': { name: '天泽履', guaCi: '履虎尾，不咥人，亨。', yao: ['素履，往无咎。', '履道坦坦，幽人贞吉。', '眇能视，跛能履。', '履虎尾，朔朔，终吉。', '夬履，贞厉。', '视履考祥，其旋元吉。'] },
  '111000': { name: '地天泰', guaCi: '小往大来，吉亨。', yao: ['拔茅茹，以其汇，征吉。', '包荒，用冯河，不遐遗。', '无平不陂，无往不复。', '翩翩，不富以其邻。', '帝乙归妹，以祉元吉。', '城复于隍，勿用师。'] },
  '000111': { name: '天地否', guaCi: '否之匪人，不利君子贞，大往小来。', yao: ['拔茅茹，以其汇，贞吉。', '包承，小人吉，大人否。', '包羞。', '有命无咎，畴离祉。', '休否，大人吉。其亡其亡，系于苞桑。', '倾否，先否后喜。'] },
  '101111': { name: '天火同人', guaCi: '同人于野，亨。利涉大川，利君子贞。', yao: ['同人于门，无咎。', '同人于宗，吝。', '伏戎于莽，升其高陵。', '乘其墉，弗克攻，吉。', '同人，先号啕而后笑，大师克相遇。', '同人于郊，无悔。'] },
  '111101': { name: '火天大有', guaCi: '元亨。', yao: ['无交害，匪咎，艰则无咎。', '大车以载，有攸往，无咎。', '公用亨于天子，小人弗克。', '匪其彭，无咎。', '厥孚交如，威如，吉。', '自天佑之，吉无不利。'] },
  '001000': { name: '地山谦', guaCi: '亨，君子有终。', yao: ['谦谦君子，用涉大川，吉。', '鸣谦，贞吉。', '劳谦，君子有终，吉。', '无不利，撝谦。', '不富以其邻，利用侵伐，无不利。', '鸣谦，利用行师，征邑国。'] },
  '000100': { name: '雷地豫', guaCi: '利建侯行师。', yao: ['鸣豫，凶。', '介于石，不终日，贞吉。', '盱豫，悔，迟有悔。', '由豫，大有得。', '贞疾，恒不死。', '冥豫，成有渝，无咎。'] },
};

// 八卦
export const BA_GUA: Record<string, { name: string; nature: string; attribute: string }> = {
  '111': { name: '乾', nature: '天', attribute: '刚健' },
  '000': { name: '坤', nature: '地', attribute: '柔顺' },
  '100': { name: '震', nature: '雷', attribute: '动' },
  '011': { name: '巽', nature: '风', attribute: '入' },
  '010': { name: '坎', nature: '水', attribute: '陷' },
  '101': { name: '离', nature: '火', attribute: '丽' },
  '001': { name: '艮', nature: '山', attribute: '止' },
  '110': { name: '兑', nature: '泽', attribute: '悦' },
};

// 六亲
export const LIU_QIN = ['父母', '兄弟', '子孙', '妻财', '官鬼'];

// 六神
export const LIU_SHEN = ['青龙', '朱雀', '勾陈', '螣蛇', '白虎', '玄武'];

export interface YaoInfo {
  position: number; // 1-6，从下到上
  isYang: boolean; // true = 阳爻，false = 阴爻
  isDong: boolean; // 是否动爻
  isChange: boolean; // 是否变爻
  yaoText?: string;
}

export interface GuaInfo {
  guaXiang: string; // 6位二进制字符串
  name: string;
  guaCi: string;
  upperGua: string; // 上卦
  lowerGua: string; // 下卦
  yaoList: YaoInfo[];
}

export interface LiuYaoResult {
  benGua: GuaInfo; // 本卦
  bianGua?: GuaInfo; // 变卦
  dongYao: number[]; // 动爻位置 [1-6]
  shiYao: number; // 世爻位置
  yingYao: number; // 应爻位置
  liuQin: string[]; // 六亲配置
  liuShen: string[]; // 六神配置
  method: 'number' | 'time' | 'manual';
  timestamp: Date;
  question?: string;
  // 增强字段
  yueJian?: string; // 月建
  riChen?: string;  // 日辰
  kongWang?: string[]; // 空亡
  yongShen?: string; // 用神
  xiShen?: string;   // 喜神
  jiShen?: string;   // 忌神
  chouShen?: string; // 仇神
  year?: string;
  month?: string;
  day?: string;
  hour?: string;
}

/**
 * 数字起卦
 * @param num1 第一个数字
 * @param num2 第二个数字
 * @param num3 第三个数字（可选，用于变爻）
 */
export function calculateByNumber(
  num1: number,
  num2: number,
  num3?: number
): LiuYaoResult {
  // 上卦 = num1 % 8 (余数0取8)
  const upperIndex = (num1 % 8) || 8;
  // 下卦 = num2 % 8 (余数0取8)
  const lowerIndex = (num2 % 8) || 8;
  // 动爻 = num3 % 6 (余数0取6)
  const dongYao = num3 ? ((num3 % 6) || 6) : undefined;

  // 获取卦象
  const upperBinary = getGuaBinaryByIndex(upperIndex);
  const lowerBinary = getGuaBinaryByIndex(lowerIndex);

  // 组合成六爻卦象（下卦在前，上卦在后）
  const guaXiang = lowerBinary + upperBinary;

  return buildLiuYaoResult(guaXiang, dongYao ? [dongYao] : [], 'number');
}

/**
 * 时间起卦
 * @param date 起卦时间
 */
export function calculateByTime(date: Date = new Date()): LiuYaoResult {
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const hour = date.getHours();

  // 年+月+日 为上卦
  const upperNum = year + month + day;
  // 年+月+日+时 为下卦
  const lowerNum = year + month + day + hour;
  // 年+月+日+时 为动爻
  const dongNum = year + month + day + hour;

  const upperIndex = (upperNum % 8) || 8;
  const lowerIndex = (lowerNum % 8) || 8;
  const dongYao = (dongNum % 6) || 6;

  const upperBinary = getGuaBinaryByIndex(upperIndex);
  const lowerBinary = getGuaBinaryByIndex(lowerIndex);
  const guaXiang = lowerBinary + upperBinary;

  return buildLiuYaoResult(guaXiang, [dongYao], 'time', date);
}

/**
 * 手动摇卦
 * @param results 六次摇卦结果，每次为 [正反面数量]
 *    3正 = 老阴(动爻，变阳) = 0
 *    2正1反 = 少阴 = 1
 *    1正2反 = 少阳 = 1
 *    3反 = 老阳(动爻，变阴) = 0
 */
export function calculateByManual(
  results: ('old-yin' | 'young-yang' | 'young-yin' | 'old-yang')[]
): LiuYaoResult {
  if (results.length !== 6) {
    throw new Error('Must provide exactly 6 toss results');
  }

  let guaXiang = '';
  const dongYao: number[] = [];

  // 从下往上排爻
  results.forEach((result, index) => {
    const position = index + 1;
    switch (result) {
      case 'old-yin': // 老阴，阴爻，动，变阳
        guaXiang = '0' + guaXiang;
        dongYao.push(position);
        break;
      case 'young-yin': // 少阴，阴爻
        guaXiang = '0' + guaXiang;
        break;
      case 'young-yang': // 少阳，阳爻
        guaXiang = '1' + guaXiang;
        break;
      case 'old-yang': // 老阳，阳爻，动，变阴
        guaXiang = '1' + guaXiang;
        dongYao.push(position);
        break;
    }
  });

  return buildLiuYaoResult(guaXiang, dongYao, 'manual');
}

/**
 * 构建六爻结果
 */
function buildLiuYaoResult(
  guaXiang: string,
  dongYao: number[],
  method: 'number' | 'time' | 'manual',
  timestamp: Date = new Date()
): LiuYaoResult {
  // 获取本卦信息
  const guaInfo = LIU_SI_SI_GUA[guaXiang] || {
    name: '未知卦',
    guaCi: '',
    yao: ['', '', '', '', '', ''],
  };

  // 分离上下卦
  const lowerBinary = guaXiang.substring(0, 3);
  const upperBinary = guaXiang.substring(3, 6);

  // 构建本卦
  const benGua: GuaInfo = {
    guaXiang,
    name: guaInfo.name,
    guaCi: guaInfo.guaCi,
    upperGua: BA_GUA[upperBinary]?.name || '未知',
    lowerGua: BA_GUA[lowerBinary]?.name || '未知',
    yaoList: [],
  };

  // 构建爻列表（从下到上）
  for (let i = 0; i < 6; i++) {
    const position = i + 1;
    const isYang = guaXiang[5 - i] === '1';
    const isDong = dongYao.includes(position);

    benGua.yaoList.push({
      position,
      isYang,
      isDong,
      isChange: isDong,
      yaoText: guaInfo.yao?.[i] || '',
    });
  }

  // 计算变卦
  let bianGua: GuaInfo | undefined;
  if (dongYao.length > 0) {
    let bianGuaXiang = '';
    for (let i = 5; i >= 0; i--) {
      const position = 6 - i;
      if (dongYao.includes(position)) {
        // 变爻，取反
        bianGuaXiang += guaXiang[i] === '1' ? '0' : '1';
      } else {
        bianGuaXiang += guaXiang[i];
      }
    }

    const bianGuaInfo = LIU_SI_SI_GUA[bianGuaXiang] || {
      name: '未知卦',
      guaCi: '',
      yao: ['', '', '', '', '', ''],
    };

    bianGua = {
      guaXiang: bianGuaXiang,
      name: bianGuaInfo.name,
      guaCi: bianGuaInfo.guaCi,
      upperGua: BA_GUA[bianGuaXiang.substring(3, 6)]?.name || '未知',
      lowerGua: BA_GUA[bianGuaXiang.substring(0, 3)]?.name || '未知',
      yaoList: [],
    };

    for (let i = 0; i < 6; i++) {
      bianGua.yaoList.push({
        position: i + 1,
        isYang: bianGuaXiang[5 - i] === '1',
        isDong: false,
        isChange: false,
        yaoText: bianGuaInfo.yao?.[i] || '',
      });
    }
  }

  // 计算世应（简化版：根据八纯卦的规律）
  const { shiYao, yingYao } = calculateShiYing(guaXiang);

  // 六亲配置（需要根据卦宫五行计算，这里使用简化版）
  const liuQin = calculateLiuQin(guaXiang);

  // 六神配置（根据日干）
  const liuShen = calculateLiuShen(timestamp);

  return {
    benGua,
    bianGua,
    dongYao,
    shiYao,
    yingYao,
    liuQin,
    liuShen,
    method,
    timestamp,
  };
}

/**
 * 根据索引获取卦的二进制表示
 */
function getGuaBinaryByIndex(index: number): string {
  // 先天八卦顺序：乾1、兑2、离3、震4、巽5、坎6、艮7、坤8
  const guaOrder: Record<number, string> = {
    1: '111', // 乾
    2: '110', // 兑
    3: '101', // 离
    4: '100', // 震
    5: '011', // 巽
    6: '010', // 坎
    7: '001', // 艮
    8: '000', // 坤
  };
  return guaOrder[index] || '111';
}

/**
 * 计算世应爻位置
 */
function calculateShiYing(guaXiang: string): { shiYao: number; yingYao: number } {
  // 简化版：根据卦象规律判断
  // 八纯卦（上下卦相同）：世在六爻，应在三爻
  const upper = guaXiang.substring(3, 6);
  const lower = guaXiang.substring(0, 3);

  if (upper === lower) {
    return { shiYao: 6, yingYao: 3 };
  }

  // 其他情况需要根据卦宫推算，这里使用简化规则
  // 一爻变：世在变动爻
  // 多爻变：世在内卦或外卦
  return { shiYao: 3, yingYao: 6 };
}

/**
 * 计算六亲
 */
function calculateLiuQin(guaXiang: string): string[] {
  // 简化版：根据卦宫五行推算
  // 这里返回一个固定的示例配置
  return ['父母', '兄弟', '子孙', '妻财', '官鬼', '父母'];
}

/**
 * 计算六神
 */
function calculateLiuShen(date: Date): string[] {
  // 根据日干确定六神起始
  // 简化版：返回固定顺序
  return ['青龙', '朱雀', '勾陈', '螣蛇', '白虎', '玄武'];
}
